version: 1.0.{build}

image: Visual Studio 2013

configuration: Release

environment:
  pound: "#"
  matrix:
  - platform: x86
    outdir: Win32
  - platform: x64
    outdir: x64

shallow_clone: true

before_build:
- curl -LsSO http://download.savannah.gnu.org/releases/freetype/freetype-2.7.1.tar.bz2
- 7z x freetype-2.7.1.tar.bz2
- 7z x freetype-2.7.1.tar
- del freetype-2.7.1.tar freetype-2.7.1.tar.bz2

build_script:
- cd freetype-2.7.1
- ..\findreplace.bat ">StaticLibrary<" ">DynamicLibrary<" builds\windows\vc2010\freetype.vcxproj
- ..\findreplace.bat "v100" "v120" builds\windows\vc2010\freetype.vcxproj
- ..\findreplace.bat "/* %pound%define FT_EXPORT(x)      extern x */" "%pound%define FT_EXPORT(x) __declspec(dllexport) x" include\freetype\config\ftoption.h
- ..\findreplace.bat "/* %pound%define FT_EXPORT_DEF(x)  x */" "%pound%define FT_EXPORT_DEF(x) __declspec(dllexport) x" include\freetype\config\ftoption.h
- msbuild /t:Rebuild /p:Configuration=Release builds\windows\vc2010\freetype.vcxproj
- cd ..

after_build:
- mkdir freetype-2.7.1-shared-%PLATFORM%
- cd freetype-2.7.1-shared-%PLATFORM%
- mkdir include
- mkdir lib
- mkdir bin
- xcopy /e ..\freetype-2.7.1\include include
- copy ..\freetype-2.7.1\objs\vc2010\%outdir%\freetype271.lib lib
- copy ..\freetype-2.7.1\objs\vc2010\%outdir%\freetype271.exp lib
- copy ..\freetype-2.7.1\objs\vc2010\%outdir%\freetype271.dll bin
- cd ..
- 7z a -ttar freetype-2.7.1-shared-%PLATFORM%.tar freetype-2.7.1-shared-%PLATFORM%
- 7z a -tgzip freetype-2.7.1-shared-%PLATFORM%.tar.gz freetype-2.7.1-shared-%PLATFORM%.tar
- del freetype-2.7.1-shared-%PLATFORM%.tar
- dir

test: off

deploy:
  release: freetype-2.7.1-shared-$(PLATFORM)
  description: 'FreeType 2.7.1 ($(PLATFORM))'
  provider: GitHub
  auth_token:
    secure: PF/wHCfSMFPCYyFh3GgjEJDHoPyPOnrmmbVMMwe8cNQBw2NL0vaYxjL1QcjMfpvL
  artifact: freetype-2.7.1-shared-$(PLATFORM).tar.gz
  draft: false
  prerelease: false
  on:
    branch: master                 # release from master branch only
    appveyor_repo_tag: true        # deploy on tag push only
